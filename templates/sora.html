<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sora Video Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            padding: 24px 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 28px;
        }

        .logo-circle {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.25);
        }

        .logo-icon {
            width: 28px;
            height: 28px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .output-card {
            background: white;
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 8px 16px rgba(0, 0, 0, 0.06);
        }

        .output-holder {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border: 2px dashed #cbd5e0;
            border-radius: 14px;
            padding: 48px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 280px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .output-holder.has-video {
            padding: 0;
            border: none;
            background: #000;
        }

        .output-placeholder {
            text-align: center;
            position: relative;
        }

        .video-icon-wrapper {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
        }

        .video-icon {
            width: 40px;
            height: 40px;
            color: #FFA500;
        }

        .output-text {
            color: #a0aec0;
            font-size: 16px;
            font-weight: 500;
        }

        .loading-state {
            display: none;
            text-align: center;
            position: relative;
        }

        .loading-state.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #4a5568;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-subtext {
            color: #a0aec0;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .loading-status {
            color: #667eea;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .error-state {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .error-state.active {
            display: block;
        }

        .error-icon {
            width: 60px;
            height: 60px;
            background: #fee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .error-text {
            color: #e53e3e;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .error-details {
            color: #718096;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .retry-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .video-display {
            width: 100%;
            max-height: 500px;
            border-radius: 14px;
            display: none;
        }

        .video-display.active {
            display: block;
        }

        .controls-container {
            background: white;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 8px 16px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .ref-img-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 14px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 200px;
            flex: 0 0 280px;
        }

        .ref-img-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .ref-img-section.has-image {
            padding: 0;
            border: none;
            background: transparent;
        }

        .upload-icon-wrapper {
            width: 56px;
            height: 56px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        }

        .upload-icon {
            width: 28px;
            height: 28px;
            color: #667eea;
        }

        .ref-text {
            color: #4a5568;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .ref-subtext {
            color: #a0aec0;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .optional-badge {
            display: inline-block;
            background: #e2e8f0;
            color: #718096;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
            display: none;
        }

        .remove-image-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 30px;
            height: 30px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #718096;
        }

        .remove-image-btn:hover {
            background: #fee;
            color: #e53e3e;
        }

        .right-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
        }

        .top-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .control-box {
            background: #f8fafc;
            border-radius: 14px;
            padding: 18px;
        }

        .control-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .control-icon {
            width: 28px;
            height: 28px;
            background: #FFF;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .control-icon svg {
            width: 15px;
            height: 15px;
            color: black;
        }

        .control-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(52px, 1fr));
            gap: 8px;
        }

        .option-btn {
            padding: 10px 8px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .option-btn:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
        }

        .option-btn.active {
            border-color: #FFF;
            background: #454545;
            color: white;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .prompt-box {
            background: #f8fafc;
            border-radius: 14px;
            padding: 18px;
            flex: 1;
        }

        .prompt-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 100px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            color: #2d3748;
            resize: vertical;
            transition: all 0.2s;
            background: white;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .prompt-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .char-count {
            color: #a0aec0;
            font-size: 12px;
        }

        .generate-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(102, 126, 234, 0.5);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            box-shadow: none;
        }

        .history-section {
            background: white;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), 0 8px 16px rgba(0, 0, 0, 0.06);
            display: none;
        }

        .history-section.active {
            display: block;
        }

        .history-header {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .history-item {
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .history-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .history-video {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .history-info {
            padding: 12px;
            background: white;
        }

        .history-prompt {
            font-size: 13px;
            color: #4a5568;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 6px;
        }

        .history-meta {
            font-size: 11px;
            color: #a0aec0;
        }

        input[type="file"] {
            display: none;
        }

        /* Login Modal */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .login-modal.active {
            display: flex;
        }

        .login-content {
            background: white;
            border-radius: 18px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .login-icon svg {
            width: 40px;
            height: 40px;
            color: white;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 12px;
        }

        .login-text {
            color: #718096;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        @media (max-width: 768px) {
            .controls-container {
                flex-direction: column;
            }

            .ref-img-section {
                flex: 1;
                width: 100%;
                min-height: 200px;
            }

            .top-controls {
                grid-template-columns: 1fr;
            }

            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }


        .quality-selector-wrapper {
    display: flex;
    gap: 6px;
    align-items: center;
}

.quality-dropdown {
    padding: 6px 10px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s;
    outline: none;
    min-width: 80px;
}

.quality-dropdown:hover {
    border-color: #cbd5e0;
    background: #f7fafc;
}

.quality-dropdown:focus {
    border-color: #FFD580;
    box-shadow: 0 0 0 3px rgba(255, 213, 128, 0.2);
}

.quality-label {
    font-size: 12px;
    color: #718096;
    font-weight: 600;
    white-space: nowrap;
}

@media (max-width: 768px) {
    .quality-selector-wrapper {
        gap: 4px;
    }
    
    .quality-label {
        font-size: 11px;
    }
    
    .quality-dropdown {
        font-size: 11px;
        padding: 5px 8px;
        min-width: 70px;
    }
}

.generate-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 3px 12px rgba(102, 126, 234, 0.4);
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}

.credit-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-left: 8px;
    padding: 3px 10px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    backdrop-filter: blur(10px);
}

.credit-icon {
    width: 12px;
    height: 12px;
    fill: currentColor;
}

@media (max-width: 768px) {
    .generate-btn {
        padding: 10px 16px;
        font-size: 13px;
    }
    
    .credit-badge {
        padding: 2px 8px;
        font-size: 11px;
    }
}


/* Generator Type Selector */
.generator-type-selector {
    margin-bottom: 24px;
}

.type-tabs {
    display: flex;
    gap: 12px;
    background: white;
    padding: 6px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
    max-width: 500px; /* Add max-width to container */
    margin: 0 auto; /* Center the tabs */
}

.type-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    color: #64748b;
    text-decoration: none;
    transition: all 0.2s ease;
    background: transparent;
}

.type-tab:hover {
    background: #f8fafc;
    color: #475569;
}

.type-tab.active {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(30, 41, 59, 0.3);
}

.type-tab svg {
    flex-shrink: 0;
}

@media (max-width: 768px) {
    .type-tab {
        font-size: 13px;
        padding: 10px 12px;
    }
    
    .type-tab svg {
        width: 16px;
        height: 16px;
        margin-right: 6px !important;
    }
}

.credit-counter {
    margin: 16px auto 0 auto;
    padding: 12px 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 1px solid #cbd5e1;
    border-radius: 12px;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    width: fit-content;
    max-width: 100%;
}

.credit-counter:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.credit-display {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.credit-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #475569;
}

.credit-count {
    font-size: 1rem;
    font-weight: 700;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.credit-count.loading {
    background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: pulse 2s infinite;
}



/* Buy Credits Button */
.buy-credits-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    margin-left: 12px;
}

.buy-credits-btn:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(245, 158, 11, 0.4);
    text-decoration: none;
    color: white;
}

.crown-icon {
    font-size: 0.875rem;
    filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
}

/* Mobile responsiveness for credit counter */
@media (max-width: 480px) {
    .credit-display {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
    }
    
    .buy-credits-btn {
        margin-left: 0;
        font-size: 0.7rem;
        padding: 5px 10px;
    }
}


/* Page Transition Loader */
.page-transition-loader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #FFF 0%, #FFF 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.page-transition-loader.active {
    opacity: 1;
    visibility: visible;
}

.loader-content {
    text-align: center;
    color: white;
}

.loader-animation {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 24px;
}

.loader-circle {
    width: 16px;
    height: 16px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    animation: bounce 1.4s ease-in-out infinite;
}

.loader-circle:nth-child(1) {
    animation-delay: 0s;
}

.loader-circle:nth-child(2) {
    animation-delay: 0.2s;
}

.loader-circle:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes bounce {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

.loader-text {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    animation: fadeInOut 1.5s ease-in-out infinite;
}

@keyframes fadeInOut {
    0%, 100% {
        opacity: 0.5;
    }
    50% {
        opacity: 1;
    }
}

.loader-bar {
    width: 200px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    overflow: hidden;
    margin: 0 auto;
}

.loader-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 2px;
    animation: loadingBar 2s ease-in-out infinite;
}

@keyframes loadingBar {
    0% {
        width: 0%;
        transform: translateX(0);
    }
    50% {
        width: 100%;
        transform: translateX(0);
    }
    100% {
        width: 100%;
        transform: translateX(100%);
    }
}

/* Fade out animation */
.page-transition-loader.fade-out {
    animation: fadeOut 0.5s ease forwards;
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
        visibility: hidden;
    }
}

.out-of-credits-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.out-of-credits-overlay.show {
    opacity: 1;
    visibility: visible;
}

.out-of-credits-modal {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 24px;
    padding: 48px 40px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.3),
        0 8px 32px rgba(0, 0, 0, 0.2);
    transform: scale(0.9) translateY(30px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.out-of-credits-overlay.show .out-of-credits-modal {
    transform: scale(1) translateY(0);
}

/* Animated background decoration */
.out-of-credits-modal::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
        rgba(251, 191, 36, 0.1) 0%, 
        rgba(245, 158, 11, 0.1) 50%, 
        rgba(251, 191, 36, 0.1) 100%);
    animation: shimmerBackground 3s ease-in-out infinite;
    z-index: 0;
}

@keyframes shimmerBackground {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    50% { transform: translate(10px, 10px) rotate(5deg); }
}

.out-of-credits-content {
    position: relative;
    z-index: 1;
}

.out-of-credits-icon {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
    font-size: 48px;
    box-shadow: 
        0 8px 24px rgba(245, 158, 11, 0.4),
        0 4px 12px rgba(251, 191, 36, 0.3);
    animation: pulseIcon 2s ease-in-out infinite;
}

@keyframes pulseIcon {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.out-of-credits-title {
    font-size: 28px;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 12px;
    letter-spacing: -0.5px;
}

.out-of-credits-subtitle {
    font-size: 18px;
    color: #64748b;
    margin-bottom: 24px;
    line-height: 1.6;
}

.credits-features {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 16px;
    padding: 20px;
    margin: 24px 0;
    text-align: left;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #f1f5f9;
}

.feature-item:last-child {
    border-bottom: none;
}

.feature-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.feature-text {
    font-size: 14px;
    color: #475569;
    font-weight: 500;
}

.out-of-credits-buttons {
    display: flex;
    gap: 12px;
    margin-top: 28px;
}

.credits-btn {
    flex: 1;
    padding: 16px 28px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.credits-btn-primary {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

.credits-btn-primary:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
}

.credits-btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.credits-btn-primary:hover::before {
    left: 100%;
}

.credits-btn-secondary {
    background: #f1f5f9;
    color: #64748b;
    border: 2px solid #e2e8f0;
}

.credits-btn-secondary:hover {
    background: #e2e8f0;
    color: #475569;
    transform: translateY(-2px);
}

/* Sparkle animation */
.sparkle {
    position: absolute;
    font-size: 20px;
    animation: sparkleFloat 3s ease-in-out infinite;
    opacity: 0;
}

@keyframes sparkleFloat {
    0%, 100% { 
        opacity: 0; 
        transform: translateY(0) rotate(0deg); 
    }
    50% { 
        opacity: 1; 
        transform: translateY(-20px) rotate(180deg); 
    }
}

.sparkle:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
.sparkle:nth-child(2) { top: 40%; right: 15%; animation-delay: 0.5s; }
.sparkle:nth-child(3) { bottom: 30%; left: 20%; animation-delay: 1s; }
.sparkle:nth-child(4) { top: 60%; right: 10%; animation-delay: 1.5s; }

/* Mobile responsive */
@media (max-width: 480px) {
    .out-of-credits-modal {
        padding: 36px 24px;
    }
    
    .out-of-credits-icon {
        width: 80px;
        height: 80px;
        font-size: 40px;
    }
    
    .out-of-credits-title {
        font-size: 24px;
    }
    
    .out-of-credits-subtitle {
        font-size: 16px;
    }
    
    .out-of-credits-buttons {
        flex-direction: column;
    }
    
    .credits-btn {
        width: 100%;
    }
}


.login-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    animation: fadeIn 0.3s ease;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.login-modal-content {
    background: white;
    border-radius: 16px;
    padding: 40px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: scaleIn 0.3s ease;
    text-align: center;
}

.login-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 16px;
}

.login-modal-text {
    color: #64748b;
    margin-bottom: 24px;
    line-height: 1.6;
}

.google-login-btn {
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0 auto;
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
}

.google-login-btn:hover {
    background: #3367d6;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
}

.skip-login-btn {
    background: transparent;
    color: #64748b;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    margin-top: 12px;
    transition: all 0.2s ease;
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
  <!--           <div class="logo-circle">
                <svg class="logo-icon" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
            </div> -->
            <h1>Video Generator - Sora</h1>
            <p>Create stunning AI-generated videos</p>
        </div>

<!-- Page Transition Loader -->
<div class="page-transition-loader" id="pageTransitionLoader">
    <div class="loader-content">
        <div class="loader-animation">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
        </div>
        <div class="loader-text">Loading...</div>
        <div class="loader-bar">
            <div class="loader-bar-fill"></div>
        </div>
    </div>
</div>



<div id="outOfCreditsOverlay" class="out-of-credits-overlay">
    <div class="out-of-credits-modal">
        <!-- Sparkle decorations -->

        
        <div class="out-of-credits-content">

            
            <h2 class="out-of-credits-title">Oops! You're Out of Credits</h2>
            <p class="out-of-credits-subtitle">
                Unlock unlimited creativity with our premium credits
            </p>
            
            
            <div class="out-of-credits-buttons">
                <button class="credits-btn credits-btn-primary" onclick="goToPricing()">
                    Buy Credits Now
                </button>
                <button class="credits-btn credits-btn-secondary" onclick="closeOutOfCreditsModal()">
                    Maybe Later
                </button>
            </div>
        </div>
    </div>
</div>



        <!-- Credit Counter Section -->
<div class="credit-counter" id="home_creditCounter" style="display: none;">
    <div class="credit-display">
        <span class="credit-label">Remaining Credits:</span>
        <span class="credit-count" id="home_creditCount">Loading...</span>
        <a href="/pricing" target="_blank" rel="noopener noreferrer" class="buy-credits-btn">
            <span class="crown-icon">👑</span>
            Buy Credits
        </a>
    </div>
</div>

<!-- Generator Type Selector -->
<div class="generator-type-selector" style="max-width: 1200px; margin: 20px auto; padding: 0 24px;">
    <div class="type-tabs">
        <a href="/" class="type-tab">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" fill="none" stroke-width="2"/>
            </svg>
            Image Generator
        </a>
        <a href="/sora" class="type-tab active">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" stroke="currentColor" fill="none" stroke-width="2"/>
            </svg>
            Video Generator
        </a>
    </div>
</div>

        <div class="output-card">
            <div class="output-holder" id="outputHolder">
                <div class="output-placeholder" id="outputPlaceholder">
                    <div class="video-icon-wrapper">
                        <svg class="video-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    </div>
                    <div class="output-text">Generated video will appear here</div>
                </div>

                <div class="loading-state" id="loadingState">
                    <div class="spinner"></div>
                    <div class="loading-text">Generating your video...</div>
                    <div class="loading-subtext">This may take 2-5 minutes</div>
                    <div class="loading-status" id="loadingStatus">Status: Initializing</div>
                </div>

                <div class="error-state" id="errorState">
                    <div class="error-icon">⚠️</div>
                    <div class="error-text">Generation Failed</div>
                    <div class="error-details" id="errorDetails"></div>
                    <button class="retry-btn" onclick="retryGeneration()">Retry</button>
                </div>

                <video class="video-display" id="videoDisplay" controls></video>
            </div>
        </div>

        <div class="controls-container">
            <label class="ref-img-section" id="refImgSection">
                <input type="file" id="imageUpload" accept="image/*">
                <div id="uploadPlaceholder">
                    <div class="upload-icon-wrapper">
                        <svg class="upload-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ref-text">Reference Image <br> </br> Face pics were not allowed currently</div>
                    <div class="ref-subtext">Click to upload</div>
                    <span class="optional-badge">Optional</span>
                </div>
                <img id="imagePreview" class="image-preview" alt="Preview">
                <button type="button" class="remove-image-btn" id="removeBtn">×</button>
            </label>

            <div class="right-section">
                <div class="top-controls">
                    <div class="control-box">
                        <div class="control-header">
                            <div class="control-icon">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                </svg>
                            </div>
                            <div class="control-title">Size</div>
                        </div>
                        <div class="option-grid" id="sizeOptions">
                            <button class="option-btn active" data-width="1920" data-height="1080">16:9</button>
                            <button class="option-btn" data-width="1080" data-height="1920">9:16</button>
                            <button class="option-btn" data-width="1080" data-height="1080">1:1</button>
                        </div>
                    </div>

                    <div class="control-box">
                        <div class="control-header">
                            <div class="control-icon">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div class="control-title">Duration</div>
                        </div>
                        <div class="option-grid" id="durationOptions">
                            <button class="option-btn active" data-duration="5">5s</button>
                            <button class="option-btn" data-duration="10">10s</button>
                            <button class="option-btn" data-duration="15">15s</button>
                        </div>
                    </div>
                </div>




               <div class="prompt-box">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
        <div class="control-header" style="margin-bottom: 0;">
            <div class="control-icon">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </div>
            <div class="prompt-title">Prompt</div>
        </div>
        
        <!-- Quality dropdown selector -->
        <div class="quality-selector-wrapper">
            <label for="qualitySelect" class="quality-label">Quality:</label>
            <select id="qualitySelect" class="quality-dropdown">
                <option value="480p" selected>480p</option>
                <option value="720p">720p</option>
                <option value="1080p">1080p</option>
            </select>
        </div>
    </div>
    
    <textarea 
        class="prompt-textarea" 
        id="promptText"
        placeholder="Describe your video... Example: A serene ocean sunset with waves gently crashing on the shore"
    ></textarea>
    <div class="prompt-footer">
        <div class="char-count" id="charCount">0 characters</div>
        <button class="generate-btn" id="generateBtn" disabled>
    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
    </svg>
    <span id="btnText">Generate</span>
    <span id="creditCost" style="display: none; margin-left: 8px; padding: 2px 8px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 4px;">
        <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2" stroke="white" stroke-width="2" fill="none"></path>
        </svg>
        <span id="creditAmount">0</span>
    </span>
</button>
    </div>
</div>



            </div>
        </div>

        <div class="history-section" id="historySection">
            <div class="history-header">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Recent Videos
            </div>
            <div class="history-grid" id="historyGrid"></div>
        </div>




        <!-- Login Modal -->
                <div id="loginModal" class="login-modal-overlay" style="display: none;">
            <div class="login-modal-content">
                <div class="login-modal-title">Continue Creating</div>
                <div class="credit-info">
                    ✨ Login to continue! 
                </div>
                <div class="login-modal-text">
                    Sign in with Google to get unlimited image generations and access premium features.
                </div>
                <button class="google-login-btn" onclick="loginWithGoogle()" id="loginbuttonid1">
            <svg class="google-logo" viewBox="0 0 24 24" width="18" height="18">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
        </button>
                <button class="skip-login-btn" onclick="closeLoginModal()">Maybe Later</button>
            </div>
        </div>
    </div>

    <script>



        // Configuration
        const API_BASE_URL = 'https://chatezzy.com'; // Replace with your backend URL
        const LOGIN_URL = '/login'; // Replace with your login page URL

        // Get auth token from localStorage
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        const CREDIT_COSTS = {
            '480p': { 5: 25, 10: 45, 15: 65 },
            '720p': { 5: 50, 10: 105, 15: 200 },
            '1080p': { 5: 135, 10: 375, 15: 875 }
        };

        function getUserId() {
            return localStorage.getItem('userId');
        }

        // Check authentication
        function checkAuth() {
            const authToken = getAuthToken();
            const userId = getUserId();

            if (!authToken) {
                showLoginModal();
                return false;
            }
            return true;
        }

  

        function redirectToLogin() {
            window.location.href = LOGIN_URL;
        }

        const CHAT_ID = 'sora_chat_' + Date.now();

        // State management
        let state = {
            prompt: '',
            width: 1920,
            height: 1080,
            quality: '480p',
            duration: 5,
            imageUrl: null,
            isGenerating: false,
            currentTask: null
        };

        let pollInterval = null;

        // DOM elements
        const promptText = document.getElementById('promptText');
        const charCount = document.getElementById('charCount');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const refImgSection = document.getElementById('refImgSection');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const removeBtn = document.getElementById('removeBtn');
        const generateBtn = document.getElementById('generateBtn');
        const sizeOptions = document.getElementById('sizeOptions');
        const durationOptions = document.getElementById('durationOptions');
        const outputHolder = document.getElementById('outputHolder');
        const outputPlaceholder = document.getElementById('outputPlaceholder');
        const loadingState = document.getElementById('loadingState');
        const loadingStatus = document.getElementById('loadingStatus');
        const errorState = document.getElementById('errorState');
        const errorDetails = document.getElementById('errorDetails');
        const videoDisplay = document.getElementById('videoDisplay');
        const historySection = document.getElementById('historySection');
        const historyGrid = document.getElementById('historyGrid');

        const qualitySelect = document.getElementById('qualitySelect');

        // Initialize on page load
        window.addEventListener('load', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check for ongoing task
            const ongoingTask = localStorage.getItem('soraOngoingTask');
            if (ongoingTask) {
                const taskData = JSON.parse(ongoingTask);
                console.log('Found ongoing task:', taskData);
                state.currentTask = taskData;
                
                // Restore quality if available
                if (taskData.quality) {
                    state.quality = taskData.quality;
                    qualitySelect.value = taskData.quality;
                }
                
                resumeTaskPolling(taskData);
            }

            // Load history
            loadHistory();

            // Set up event listeners
            setupEventListeners();

            updateCreditDisplay();
        }


        function setupEventListeners() {
    promptText.addEventListener('input', function(e) {
        state.prompt = e.target.value;
        charCount.textContent = e.target.value.length + ' characters';
        updateGenerateButton();
    });

    imageUpload.addEventListener('change', handleImageUpload);
    removeBtn.addEventListener('click', removeImage);
    generateBtn.addEventListener('click', startGeneration);

    sizeOptions.addEventListener('click', function(e) {
        if (e.target.classList.contains('option-btn')) {
            document.querySelectorAll('#sizeOptions .option-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            state.width = parseInt(e.target.dataset.width);
            state.height = parseInt(e.target.dataset.height);
        }
    });

    durationOptions.addEventListener('click', function(e) {
        if (e.target.classList.contains('option-btn')) {
            document.querySelectorAll('#durationOptions .option-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            state.duration = parseInt(e.target.dataset.duration);
            updateCreditDisplay(); // Update when duration changes
        }
    });

    qualitySelect.addEventListener('change', function(e) {
        state.quality = e.target.value;
        updateCreditDisplay(); // Update when quality changes
    });
}

function calculateCredits(quality, duration) {
    return CREDIT_COSTS[quality][duration] || 0;
}


function updateCreditDisplay() {
    const credits = calculateCredits(state.quality, state.duration);
    const creditAmount = document.getElementById('creditAmount');
    const creditCost = document.getElementById('creditCost');
    const btnText = document.getElementById('btnText');
    
    if (credits > 0) {
        creditAmount.textContent = credits;
        creditCost.style.display = 'flex';
        btnText.textContent = 'Generate';
    }
}

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.imageUrl = e.target.result;
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    uploadPlaceholder.style.display = 'none';
                    removeBtn.style.display = 'flex';
                    refImgSection.classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(e) {
            e.preventDefault();
            e.stopPropagation();
            imagePreview.style.display = 'none';
            uploadPlaceholder.style.display = 'block';
            removeBtn.style.display = 'none';
            refImgSection.classList.remove('has-image');
            imageUpload.value = '';
            state.imageUrl = null;
        }

        function updateGenerateButton() {
            generateBtn.disabled = state.prompt.trim().length === 0 || state.isGenerating;
        }

        async function startGeneration() {
            if (state.isGenerating) return;

            // Check auth ONLY when user clicks generate
            const authToken = getAuthToken();
            const userId = getUserId();
            
            if (!authToken || !userId) {
                showLoginModal();
                return;
            }

            state.isGenerating = true;
            updateGenerateButton();
            showLoading();

            const requestId = 'googlenanobananadotcom_' + Date.now();

            const formData = new FormData();
            formData.append('prompt', state.prompt);
            formData.append('authToken', authToken);
            formData.append('video_duration', state.duration);
            formData.append('video_width', state.width);
            formData.append('video_height', state.height);
            formData.append('quality', state.quality);
            formData.append('requestId', requestId);
            formData.append('chat_id', "cWQ3di1zZGtkZ3Y");

            if (imageUpload.files[0]) {
                formData.append('reference_image', imageUpload.files[0]);
            }

            try {
                const response = await fetch(API_BASE_URL + '/chat/v2/sora-initiate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status_code === 400 && data.detail === "Insufficient credits. Please top up to continue.") {
                    showOutOfCreditsModal();
                    state.isGenerating = false;
                    updateGenerateButton();
                    return;
                }

                if (data.status === 'error') {
                    showError(data.error);
                    state.isGenerating = false;
                    updateGenerateButton();
                    return;
                }

                console.log('Task initiated:', data);

                // Store task in localStorage
                const taskData = {
                    taskId: data.task_id,
                    requestId: requestId,
                    prompt: state.prompt,
                    width: state.width,
                    height: state.height,
                    duration: state.duration,
                    timestamp: Date.now()
                };

                localStorage.setItem('soraOngoingTask', JSON.stringify(taskData));
                state.currentTask = taskData;

                // Start polling for status
                startPolling(taskData);

            } catch (error) {
                console.error('Error initiating generation:', error);
                showError('Failed to start video generation: ' + error.message);
                state.isGenerating = false;
                updateGenerateButton();
            }
        }

        function startPolling(taskData) {
    // Don't use setInterval - just start first check
    checkTaskStatus(taskData);
}

        function resumeTaskPolling(taskData) {
            state.isGenerating = true;
            updateGenerateButton();
            showLoading();
            updateLoadingStatus('Resuming...');
            startPolling(taskData);
        }

       async function checkTaskStatus(taskData) {
    const authToken = getAuthToken();
    const userId = getUserId();
    
    const formData = new FormData();
    formData.append('task_id', taskData.taskId);
    formData.append('authToken', authToken);
    formData.append('user_id', userId);
    formData.append('chat_id', CHAT_ID);
    formData.append('requestId', taskData.requestId);
    
    try {
        const response = await fetch(API_BASE_URL + '/chat/v2/sora-check-status', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        console.log('Status check:', data);
        
        if (data.status === 'pending') {
            // Still processing
            updateLoadingStatus(data.current_status || 'Processing');
            
            // ✅ Wait 5 seconds AFTER getting response, then poll again
            setTimeout(function() {
                checkTaskStatus(taskData);
            }, 5000);
        } 
        else if (data.status === 'completed') {
            // Video ready!
            stopPolling();
            onVideoCompleted(data, taskData);
        } 
        else if (data.status === 'failed') {
            stopPolling();
            showError(data.error || 'Video generation failed');
            state.isGenerating = false;
            updateGenerateButton();
        } 
        else if (data.status === 'cancelled') {
            stopPolling();
            showError('Video generation was cancelled');
            state.isGenerating = false;
            updateGenerateButton();
        }
        else if (data.status === 'error') {
            stopPolling();
            showError(data.error || 'An error occurred');
            state.isGenerating = false;
            updateGenerateButton();
        }
        
    } catch (error) {
        console.error('Error checking status:', error);
        updateLoadingStatus('Retrying...');
        
        // ✅ Wait 5 seconds after error, then retry
        setTimeout(function() {
            checkTaskStatus(taskData);
        }, 5000);
    }
}

function stopPolling() {
    // No interval to clear anymore, but keep for safety
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
    
    // Remove from localStorage
    localStorage.removeItem('soraOngoingTask');
    state.currentTask = null;
}

        function onVideoCompleted(data, taskData) {
            console.log('Video completed:', data);

            // Hide loading
            hideLoading();

            // Show video
            videoDisplay.src = data.video_url;
            videoDisplay.classList.add('active');
            outputHolder.classList.add('has-video');

            // Save to history
            saveToHistory({
                videoUrl: data.video_url,
                filename: data.filename,
                prompt: taskData.prompt,
                width: taskData.width,
                height: taskData.height,
                duration: taskData.duration,
                quality: taskData.quality,
                timestamp: Date.now()
            });

            // Load updated history
            loadHistory();

            // Reset state
            state.isGenerating = false;
            updateGenerateButton();
        }

        function showLoading() {
            outputPlaceholder.style.display = 'none';
            errorState.classList.remove('active');
            videoDisplay.classList.remove('active');
            loadingState.classList.add('active');
            outputHolder.classList.remove('has-video');
        }

        function hideLoading() {
            loadingState.classList.remove('active');
        }

        function showError(message) {
            outputPlaceholder.style.display = 'none';
            loadingState.classList.remove('active');
            videoDisplay.classList.remove('active');
            errorState.classList.add('active');
            errorDetails.textContent = message;
            outputHolder.classList.remove('has-video');

            // Remove ongoing task
            stopPolling();
        }

        function updateLoadingStatus(status) {
            const statusMap = {
                'queued': 'Queued',
                'preprocessing': 'Preprocessing',
                'running': 'Generating Video',
                'processing': 'Finalizing',
                'Resuming...': 'Resuming',
                'Retrying...': 'Retrying'
            };

            loadingStatus.textContent = 'Status: ' + (statusMap[status] || status);
        }

        function retryGeneration() {
            errorState.classList.remove('active');
            outputPlaceholder.style.display = 'block';
            
            if (state.prompt) {
                startGeneration();
            }
        }

        // History management
        function saveToHistory(videoData) {
            let history = getHistory();
            
            // Add new video at the beginning
            history.unshift(videoData);
            
            // Keep only last 5 videos
            if (history.length > 5) {
                history = history.slice(0, 5);
            }
            
            localStorage.setItem('soraHistory', JSON.stringify(history));
        }

        function getHistory() {
            const historyJson = localStorage.getItem('soraHistory');
            return historyJson ? JSON.parse(historyJson) : [];
        }

        function loadHistory() {
    const history = getHistory();
    
    if (history.length === 0) {
        historySection.classList.remove('active');
        return;
    }
    
    historySection.classList.add('active');
    historyGrid.innerHTML = '';
    
    history.forEach(function(video, index) {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.onclick = function() {
            playHistoryVideo(video);
        };
        
        const videoEl = document.createElement('video');
        videoEl.className = 'history-video';
        videoEl.src = video.videoUrl;
        videoEl.muted = true;
        
        const info = document.createElement('div');
        info.className = 'history-info';
        
        const prompt = document.createElement('div');
        prompt.className = 'history-prompt';
        prompt.textContent = video.prompt;
        
        const meta = document.createElement('div');
        meta.className = 'history-meta';
        // ADD quality to metadata display:
        meta.textContent = video.duration + 's • ' + (video.quality || '720p') + ' • ' + video.width + 'x' + video.height;
        
        info.appendChild(prompt);
        info.appendChild(meta);
        item.appendChild(videoEl);
        item.appendChild(info);
        historyGrid.appendChild(item);
    });
}

        function playHistoryVideo(video) {
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Hide all states
            outputPlaceholder.style.display = 'none';
            loadingState.classList.remove('active');
            errorState.classList.remove('active');
            
            // Show video
            videoDisplay.src = video.videoUrl;
            videoDisplay.classList.add('active');
            outputHolder.classList.add('has-video');
        }

        // Clear history function (optional, can add a button for this)
        function clearHistory() {
            localStorage.removeItem('soraHistory');
            loadHistory();
        }

        // Handle page visibility changes (pause/resume polling)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page hidden, don't stop polling but reduce frequency
                if (pollInterval && state.isGenerating) {
                    clearInterval(pollInterval);
                    pollInterval = setInterval(function() {
                        if (state.currentTask) {
                            checkTaskStatus(state.currentTask);
                        }
                    }, 10000); // Check every 10 seconds when hidden
                }
            } else {
                // Page visible, resume normal polling
                if (state.isGenerating && state.currentTask) {
                    if (pollInterval) {
                        clearInterval(pollInterval);
                    }
                    startPolling(state.currentTask);
                }
            }
        });

        // Handle page unload (cleanup)
        window.addEventListener('beforeunload', function() {
            // Don't clear ongoing task from localStorage
            // It will be resumed on next page load
        });


        async function fetchAndDisplayHomeCredits() {
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken || authToken.trim() === '') {
                return;
            }
            
            const creditCounter = document.getElementById('home_creditCounter');
            const creditCount = document.getElementById('home_creditCount');
            
            creditCounter.style.display = 'block';
            
            try {
                const response = await fetch('https://chatezzy.com/api/get-nano-credits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `authToken=${encodeURIComponent(authToken)}`
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.creditcount && data.creditcount > 0) {
                    creditCount.textContent = data.creditcount;
                    creditCount.classList.remove('loading');
                } else {
                    creditCounter.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error fetching home credits:', error);
                creditCounter.style.display = 'none';
            }
        }


        function updateHomeCredit(newCreditCount) {
            const creditCounter = document.getElementById('home_creditCounter');
            const creditCount = document.getElementById('home_creditCount');
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken || authToken.trim() === '') {
                return;
            }
            
            try {
                const safeCredits = Math.max(0, parseInt(newCreditCount) || 0);
                
                if (safeCredits >= 0) {
                    creditCounter.style.display = 'block';
                    creditCount.textContent = safeCredits;
                    creditCount.classList.remove('loading');
                } else {
                    creditCounter.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error updating home credit display:', error);
                creditCounter.style.display = 'none';
            }
        }

        // Call on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetchAndDisplayHomeCredits();
        });


        // Page Transition Functions
function showPageLoader() {
    const loader = document.getElementById('pageTransitionLoader');
    loader.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hidePageLoader() {
    const loader = document.getElementById('pageTransitionLoader');
    loader.classList.add('fade-out');
    document.body.style.overflow = 'auto';
    
    setTimeout(() => {
        loader.classList.remove('active', 'fade-out');
    }, 500);
}

// Attach to navigation links
document.addEventListener('DOMContentLoaded', function() {
    // Hide loader when page loads
    hidePageLoader();
    
    // Add transition to generator type tabs
    const tabLinks = document.querySelectorAll('.type-tab');
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            
            // Show loader
            showPageLoader();
            
            // Navigate after short delay
            setTimeout(() => {
                window.location.href = href;
            }, 300);
        });
    });
    
    // Handle browser back/forward buttons
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            hidePageLoader();
        }
    });
});

// Show loader on page unload (browser navigation)
window.addEventListener('beforeunload', function() {
    showPageLoader();
});


function showOutOfCreditsModal() {
    const overlay = document.getElementById('outOfCreditsOverlay');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// Close out of credits modal
function closeOutOfCreditsModal() {
    const overlay = document.getElementById('outOfCreditsOverlay');
    overlay.classList.remove('show');
    document.body.style.overflow = 'auto';
}

function goToPricing() {
    window.open('/pricing', '_blank');
}

// Close on overlay click
document.getElementById('outOfCreditsOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeOutOfCreditsModal();
    }
});

// Close with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const overlay = document.getElementById('outOfCreditsOverlay');
        if (overlay.classList.contains('show')) {
            closeOutOfCreditsModal();
        }
    }
});


function showLoginModal() {
    document.getElementById('loginModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Close login modal
function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

async function loginWithGoogle() {
    // Implement your Google OAuth login here
    // Example redirect:
    const button = document.getElementById('loginbuttonid1');
    button.disabled = true;
    //button.style.opacity = '0.0';

    let refer_code = localStorage.getItem('refer_code'); 

    try {
        const url = refer_code ? `/logggin/v2?refer_code=${encodeURIComponent(refer_code)}` : '/logggin/v2';

        const response = await fetch(url);
        const data = await response.json();
        
        if (data.redirect_uri) {
            const popup = window.open(data.redirect_uri, 'oauth_popup', 'width=500,height=600');

            // Check if popup was blocked
            if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                // Store current page before redirecting
                localStorage.setItem('pre_auth_url', window.location.href);
                // Popup blocked - use full page redirect instead
                window.location.href = data.redirect_uri;
                return;
            }

            // Poll the popup URL instead of listening for messages
            const checkPopup = setInterval(() => {
                try {
                    if (popup.closed) {
                        clearInterval(checkPopup);
                        console.log('Popup closed');
                        return;
                    }

                    // Check if popup URL contains our success page
                    const popupUrl = popup.location.href;
                    if (popupUrl.includes('/oauth-success')) {
                        const urlParams = new URLSearchParams(popup.location.search);
                        const token = urlParams.get('token');
                        const name = urlParams.get('name');
                        const userId = urlParams.get('id');
                        
                        if (token) {
                            // Save token
                            localStorage.setItem('authToken', token);
                            localStorage.setItem('user_id', userId);
                            console.log('Auth token saved:', token);
                            
                            // Close popup and cleanup
                            popup.close();
                            clearInterval(checkPopup);
                            
                            location.reload();
                        }
                    }
                } catch (e) {
                    // Cross-origin error - popup is still on Google's domain
                    // This is expected during the OAuth flow
                }
            }, 1000);
        }
    } catch (error) {
        location.reload();
    } finally {
        button.disabled = false;
    }
    
    // Or if using Google OAuth library:
    // gapi.auth2.getAuthInstance().signIn();
}


    </script>
</body>
</html>